<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Derivación de Tickets — Protecta Seguros</title>
  <meta name="description"
    content="Sistema inteligente de derivación y clasificación de tickets de soporte — Protecta Seguros" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <!-- Chart.js para gráficos del dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>

  <!-- ── Header ── -->
  <header>
    <div class="header-icon">
      <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2" />
        <rect x="9" y="3" width="6" height="4" rx="1" />
        <line x1="9" y1="12" x2="15" y2="12" />
        <line x1="9" y1="16" x2="13" y2="16" />
      </svg>
    </div>
    <div>
      <h1>Sistema de Derivación Inteligente</h1>
      <p>Pipeline multiagente — Histórico · Estimador · Complejidad · Orquestador</p>
    </div>
    <span class="header-badge">v3.0</span>
  </header>

  <!-- ── Subbar ── -->
  <div class="subbar" style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:.5rem;">
    <div style="display:flex; align-items:center; gap:.5rem;">
      <svg class="subbar-icon" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10" />
        <line x1="12" y1="8" x2="12" y2="12" />
        <line x1="12" y1="16" x2="12.01" y2="16" />
      </svg>
      <span>Protecta Seguros · Service Desk · Orquestado vía n8n</span>
    </div>
    <div style="display:flex; align-items:center; gap:.5rem;">
      <!-- Botón Dashboard (scroll a sección) -->
      <button onclick="document.getElementById('dashboard-section').scrollIntoView({behavior:'smooth'})"
        style="background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.3); color:#fff;
               padding:.25rem .75rem; border-radius:6px; font-size:.75rem; cursor:pointer;
               display:flex; align-items:center; gap:.35rem;">
        <svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
          <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
        </svg>
        Dashboard
      </button>
      <!-- Botón MLflow UI (nueva pestaña) -->
      <a href="http://localhost:5001" target="_blank" rel="noopener"
        style="background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.3); color:#fff;
               padding:.25rem .75rem; border-radius:6px; font-size:.75rem; cursor:pointer; text-decoration:none;
               display:flex; align-items:center; gap:.35rem;">
        <svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
        </svg>
        MLflow UI
      </a>
    </div>
  </div>

  <main>

    <!-- ── Formulario ── -->
    <div class="card">
      <div class="card-header">
        <div class="card-header-icon">
          <svg viewBox="0 0 24 24" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14 2 14 8 20 8" />
            <line x1="12" y1="18" x2="12" y2="12" />
            <line x1="9" y1="15" x2="15" y2="15" />
          </svg>
        </div>
        <div class="card-title">Nuevo Ticket</div>
      </div>

      <form id="formTicket" novalidate>

        <!-- Clasificación -->
        <div class="section-label">Clasificación</div>
        <div class="row2">
          <div class="form-group">
            <label>Tipo de Incidencia <span class="required">*</span></label>
            <select id="tipo_incidencia" required>
              <option value="">Seleccionar...</option>
              <option value="Incidente">Incidente</option>
              <option value="Solicitud">Solicitud</option>
            </select>
          </div>
          <div class="form-group">
            <label>Tipo de Atención SD <span class="required">*</span></label>
            <select id="tipo_atencion_sd" required>
              <option value="">Seleccionar...</option>
              <option>ACTIVACIÓN DE BOT Y REPROCESO</option>
              <option>ACTIVACIÓN O CREACIÓN DE USUARIOS</option>
              <option>ACTUALIZACIÓN DE CIIU</option>
              <option>ACTUALIZACIÓN DE CUPONES</option>
              <option>ACTUALIZACIÓN DE DATOS DE CLIENTES</option>
              <option>ACTUALIZACIÓN DE EMISIÓN DE SOAT</option>
              <option>ACTUALIZACIÓN DE ESTADO</option>
              <option>ACTUALIZACIÓN DE FECHAS EN C360</option>
              <option>ACTUALIZAR DATOS DEL CERTIFICADO</option>
              <option>ACTUALIZAR DATOS DEL COMPROBANTE</option>
              <option>ACTUALIZAR DATOS DEL SINIESTRO</option>
              <option>ACTUALIZAR PRIMAS Y/O COMISIONES</option>
              <option>AGENCIAMIENTO</option>
              <option>AJUSTAR CANTIDAD DE ASEGURADOS</option>
              <option>ANULACIÓN DE CÓDIGO DE PAGO</option>
              <option>ANULACIÓN DE COMPROBANTE</option>
              <option>ANULACIÓN DE CUPONES</option>
              <option>ANULACIÓN DE MOVIMIENTO</option>
              <option>ANULACIÓN DE PÓLIZA</option>
              <option>ANULACIÓN DE RECIBOS</option>
              <option>ANULACIÓN Y GENERACIÓN DE COMPROBANTES</option>
              <option>ANULAR MOVIMIENTO PENDIENTE EN COTIZACIÓN</option>
              <option>CAMBIO COBERTURAS Y/O PRIMAS DE PÓLIZA Y/O SUMAS ASEGURADAS</option>
              <option>CAMBIO DE AGENCIAMIENTO</option>
              <option>CAMBIO DE ESTADO EN LAS COMISIONES</option>
              <option>CAMBIO DE ESTADO SINIESTRO</option>
              <option>CAMBIO DE FECHA DE LIQUIDACIÓN</option>
              <option>CAMBIO DE FECHA DE PRELIMINAR</option>
              <option>CAMBIO DE FECHA DE VIGENCIA</option>
              <option>CAMBIO DE PORCENTAJE DE COMISIÓN</option>
              <option>CAMBIO DE TASAS</option>
              <option>CAMBIO DE VIGENCIA Y GENERACIÓN DE NC</option>
              <option>CAMBIO PERIODO PRELIMINAR</option>
              <option>CARGA DE TRAMA</option>
              <option>CARGA TRAMA CON FORMATO INCORRECTO</option>
              <option>CIERRE DEL TICKET</option>
              <option>CONCILIACIÓN DE PLANILLA</option>
              <option>CONCILIACIÓN MANUAL</option>
              <option>CONSULTA DE CLIENTE</option>
              <option>CONSULTA DEL CLIENTE</option>
              <option>CORRECCIÓN DE ASEGURADO</option>
              <option>CORRECCIÓN DE COMISIONES</option>
              <option>CORRECCIÓN DE DATA DE SINIESTROS</option>
              <option>CORRECCIÓN DE DATOS</option>
              <option>CORRECCIÓN DE INFORMACIÓN DE ASEGURADO</option>
              <option>CORRECCIÓN DE MONTO</option>
              <option>CORRECCIÓN DE PRIMAS MÍNIMAS Y VIGENCIAS ATÍPICAS</option>
              <option>CORRECCIÓN DE PROCESO EN COTIZACIÓN</option>
              <option>CORRECCIÓN DE TASAS</option>
              <option>CORRECCIÓN EN AGENCIAMIENTO</option>
              <option>CORRECCIÓN EN PROCESO DE REVERSO</option>
              <option>CUADRO DE PÓLIZA BELCORP</option>
              <option>CUPONERA</option>
              <option>DATO DE FECHA DE NACIMIENTO VACÍO EN RENIEC</option>
              <option>DEMORA EN NOTIFICACIÓN DEL PAGO DE LA PASARELA</option>
              <option>DESAFILIACIÓN DE RENOVACIÓN</option>
              <option>DESCONOCIMIENTO DE USUARIO</option>
              <option>DIFERENCIA DE COMISIONES</option>
              <option>DUPLICIDAD DE DATOS</option>
              <option>EMISIÓN</option>
              <option>ENDOSO Y REFACTURACIÓN</option>
              <option>ENVÍO DE CORREO A USUARIOS</option>
              <option>ERROR AL EMITIR PÓLIZA</option>
              <option>ERROR AL EMITIR PÓLIZA - POR BROKER NO CONFIGURADO</option>
              <option>ERROR AL RENOVAR LA TRAMA DE SANITAS</option>
              <option>ERROR CON SERVICIO DE RENIEC</option>
              <option>ERROR DE CONECTIVIDAD SERVIDOR</option>
              <option>ERROR DE COTIZACIÓN</option>
              <option>ERROR DE DATA</option>
              <option>ERROR DE SERVICIO DE EMISIÓN PARA SOAT</option>
              <option>ERROR DE SERVICIO DE EPS</option>
              <option>ERROR DE SERVICIO PAGO EFECTIVO</option>
              <option>ERROR DE SERVIDOR</option>
              <option>ERROR DE USUARIO</option>
              <option>ERROR EN INFORMACIÓN</option>
              <option>ERROR EN PROCESO AUTOMÁTICO DE EXCLUSIONES DE SANITAS</option>
              <option>ERROR EN SERVICIO DE ASBANC</option>
              <option>ERROR EN SISTEMA DE CONCILIACIONES</option>
              <option>ERROR EN TRÁMITES</option>
              <option>ERROR FLUJO DE EXCLUSIÓN CON ASEGURADOS YA EXCLUIDOS</option>
              <option>EXCLUSIÓN</option>
              <option>FACTURACIÓN</option>
              <option>GENERACIÓN DE BOLETA</option>
              <option>GENERACIÓN DE COMPROBANTE</option>
              <option>GENERACIÓN DE NC</option>
              <option>GENERACIÓN DE REPORTE</option>
              <option>GENERAR PLANILLA</option>
              <option>GENERAR REPORTE DE ASEGURADOS</option>
              <option>GENERAR REPORTE DE SINIESTROS</option>
              <option>INCLUSIÓN</option>
              <option>INCLUSIÓN MANUAL DE ASEGURADOS</option>
              <option>INFORMACIÓN DE PLANILLA</option>
              <option>INFORMACIÓN DE USUARIO EN SISTEMA CONCILIACIONES</option>
              <option>INFORMACIÓN INCOMPLETA PARA ATENCIÓN</option>
              <option>INTERFAZ A DEMANDA</option>
              <option>INTERFAZ DE OPERACIONES</option>
              <option>LENTITUD EN GENERACIÓN DE DOCUMENTOS</option>
              <option>LIQUIDACIÓN MANUAL</option>
              <option>MARCA DE INTERFAZ</option>
              <option>MIGRACIÓN DE CARTERA DE VLEY</option>
              <option>MIGRACIÓN DE PLACAS A APESEG</option>
              <option>MODIFICACIÓN DE DATA SINIESTROS</option>
              <option>MODIFICACIÓN DE DOCUMENTOS</option>
              <option>MODIFICACIÓN DE SUMAS ASEGURADAS</option>
              <option>NO FIGURA EL COTIZADOR PARA PENSIÓN</option>
              <option>NO FIGURA LA PÓLIZA EN LA PLATAFORMA DIGITAL</option>
              <option>NO FIGURAN DOCUMENTOS</option>
              <option>NO FIGURAN TASAS COTIZADOR</option>
              <option>NO GENERA MOVIMIENTOS - PRORRATEO</option>
              <option>NO SE GENERA MOVIMIENTO</option>
              <option>NO SE GENERA MOVIMIENTO POR CIP PENDIENTE</option>
              <option>NO TRAE FECHA DE RETROACTIVIDAD</option>
              <option>OTROS</option>
              <option>PASE A PRODUCCIÓN</option>
              <option>PROCESO DE INTERFAZ A SINIESTROS</option>
              <option>PRORRATEO</option>
              <option>REENVÍO DE INFORMACIÓN O MOVIMIENTOS A GRANDIA</option>
              <option>REFACTURACIÓN</option>
              <option>REGISTRO C360</option>
              <option>REGISTRO DE BROKER PARA SANITAS</option>
              <option>RELANZAMIENTO DE COTIZACIÓN A TÉCNICA</option>
              <option>RENOVACIÓN</option>
              <option>REPORTE</option>
              <option>REPORTE SUCAVE</option>
              <option>REPORTERÍA</option>
              <option>REVERSA DE MOVIMIENTO (TACHITO)</option>
              <option>REVERSO DE CARGA</option>
              <option>REVERSO DE COTIZACIÓN POR FLUJO PENDIENTE CON TÉCNICA</option>
              <option>REVERSO DE MOVIMIENTO</option>
              <option>REVERSO DE MOVIMIENTO DE PÓLIZA</option>
              <option>REVERSO MANUAL DE MOVIMIENTO DE SCTR</option>
              <option>REVISAR EL PROCESO DE CONSULTA DE TRANSACCIONES DE VLEY</option>
              <option>REVISAR EL PROCESO DE COTIZACIÓN DE VLEY</option>
              <option>REVISAR EL PROCESO DE EMISIÓN DE SCTR</option>
              <option>REVISAR EL PROCESO DE EMISIÓN DE VLEY</option>
              <option>REVISAR EL PROCESO DE EMISIÓN DE SCTR SANITAS</option>
              <option>REVISAR EL PROCESO DE INCLUSIÓN DE SCTR</option>
              <option>REVISAR EL PROCESO DE PAGO CON CIP</option>
              <option>REVISAR EL PROCESO DE PAGO EN KUSHKI</option>
              <option>REVISAR EL PROCESO DE RENOVACIÓN DE SCTR</option>
              <option>REVISAR EL PROCESO DE RENOVACIÓN DE VLEY</option>
              <option>REVISAR EL PROCESO DE REVERSO DE TRANSACCIÓN PENDIENTE DE COTIZACIÓN</option>
              <option>REVISAR EL PROCESO DE SINIESTROS</option>
              <option>REVISAR EL PROCESO DE SINIESTROS DE AP</option>
              <option>REVISAR EL PROCESO EN COTIZACIÓN DE AP</option>
              <option>REVISAR EL PROCESO EN COTIZACIÓN DE SCTR</option>
              <option>REVISAR EL REPORTE DE SINIESTROS</option>
              <option>REVISAR LA INTERFAZ DE SINIESTRO</option>
              <option>REVISAR LA VALIDACIÓN DE LA TRAMA DE VLEY</option>
              <option>REVISAR MOVIMIENTOS PENDIENTE EN COTIZACIÓN</option>
              <option>REVISIÓN DE COMPROBANTE</option>
              <option>REVISIÓN DE COMPROBANTES RECHAZADOS POR SUNAT</option>
              <option>REVISIÓN DE PROFORMAS DE SANITAS</option>
              <option>REVISIÓN EN REGISTRO CONTRATANTE Y/O INTERMEDIARIO</option>
              <option>REVISIÓN Y/O CORRECCIÓN DE RECIBOS EN INTERFAZ</option>
              <option>REVISIÓN DE FLUJO COMISIONES</option>
              <option>SELLO CANCELADO</option>
              <option>SOLICITUD</option>
              <option>SUSPENSIÓN DE FACTURACIÓN</option>
              <option>TIME-OUT EN JIRA</option>
              <option>VALIDACIÓN DE MÓDULO DE PAGO SCTR</option>
              <option>VALIDACIÓN DE TRAMA</option>
              <option>VALIDAR EMISIÓN DE SOAT</option>
              <option>VISUALIZACIÓN DE DOCUMENTOS</option>
              <option value="">(EN BLANCO)</option>
            </select>
          </div>
        </div>

        <!-- Detalle -->
        <div class="section-label">Detalle del Ticket</div>
        <div class="form-group">
          <label>Resumen <span class="required">*</span></label>
          <input id="resumen" type="text" placeholder="Descripción breve del problema o solicitud" required />
        </div>
        <div class="row2">
          <div class="form-group">
            <label>Área <span class="required">*</span></label>
            <select id="area" required>
              <option>Analatica y Actuarial</option>
              <option>Cobranzas</option>
              <option>Operaciones</option>
              <option>Comercial Masivos</option>
              <option>Contabilidad</option>
              <option>Cultura Organizacional</option>
              <option>Marketing</option>
              <option>Operaciones</option>
              <option>Recepcion</option>
              <option>Riesgos Operacionales</option>
              <option>Servicio al Cliente</option>
              <option>Siniestros</option>
              <option>Soluciones de Clientes</option> 
              <option>Técnica</option>
              <option>TI</option>
            </select>
          </div>
          <div class="form-group">
            <label>Producto</label>
            <select id="producto">
              <option value="">Seleccionar...</option>
              <option>SOAT</option>
              <option>Vida Ley</option>
              <option>SCTR</option>
              <option>Accidentes Personales</option>
              <option>Vida Grupo</option>
              <option>Otro</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Aplicativo</label>
          <select id="aplicativo">
            <option value="">Seleccionar...</option>
            <option>BackOffice</option>
            <option>C360</option>
            <option>Chrome</option>
            <option>Conciliaciones automáticas</option>
            <option>Cotizador -> Accidentes Personales</option>
            <option>Cotizador -> Vida Grupo</option>
            <option>Cotizador -> Vida Ley</option>
            <option>Ecommerce -> Accidentes Personales</option>
            <option>Ecommerce -> SOAT</option>
            <option>eFacturación</option>
            <option>Exactus</option>
            <option>Integrador</option>
            <option>Net privada</option>
            <option>OnBase</option>
            <option>OnBase -> CxP Comisiones</option>
            <option>Plataforma de consultas</option>
            <option>Plataforma de Contratos</option>
            <option>Plataforma de vida</option>
            <option>Plataforma Digital</option>
            <option>Plataforma Digital -> Comisiones</option>
            <option>Plataforma Digital -> Interfaz Automática</option>
            <option>Plataforma Digital -> PD - Accidentes Personales</option>
            <option>Plataforma Digital -> PD - SCTR</option>
            <option>Plataforma Digital -> PD - SOAT Digital</option>
            <option>Plataforma Digital -> PD - Vida Grupo</option>
            <option>Plataforma Digital -> PD - Vida Ley</option>
            <option>Siniestros</option>
            <option>SOAT</option>
            <option>Tarifario -> Accidentes Personales</option>
            <option>Visual Time</option>
          </select>
        </div>

        <!-- Informante -->
        <div class="section-label">Informante</div>
        <div class="form-group">
          <label>Informador <span class="required">*</span></label>
          <div class="search-dropdown" id="dd-container">
            <input id="informador-search" type="text" placeholder="Buscar por nombre de usuario..."
              autocomplete="off" />
            <svg class="dd-arrow" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="#94a3b8"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9" />
            </svg>
            <div class="dd-list" id="dd-list"></div>
          </div>
          <input type="hidden" id="informador" />
        </div>

        <!-- Impacto -->
        <div class="section-label">Impacto</div>
        <div class="row2">
          <div class="form-group">
            <label>Cantidad de afectados</label>
            <input id="cantidad_afectados" type="number" min="1" value="1" />
          </div>
          <div class="form-group" style="display:flex; align-items:flex-end;">
            <label class="checkbox-row" style="width:100%; margin:0; cursor:pointer;">
              <input type="checkbox" id="impacta_al_cierre" />
              <span style="font-size:.82rem; color:var(--text); font-weight:400;">Impacta al cierre contable</span>
            </label>
          </div>
        </div>

        <button class="btn" type="submit" id="btnEnviar">
          <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13" />
            <polygon points="22 2 15 22 11 13 2 9 22 2" />
          </svg>
          <span>Derivar Ticket</span>
        </button>
      </form>
    </div>

    <!-- ── Panel derecho ── -->
    <div style="display:flex; flex-direction:column; gap:1.4rem;">

      <!-- Historial -->
      <div class="card">
        <div class="card-header">
          <div class="card-header-icon">
            <svg viewBox="0 0 24 24" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10" />
              <polyline points="12 6 12 12 16 14" />
            </svg>
          </div>
          <div class="card-title">Últimas Derivaciones</div>
        </div>
        <ul id="historial-list">
          <li style="color:var(--text-muted); font-size:.8rem; padding:.4rem 0;">Sin tickets procesados aún.</li>
        </ul>
        <a class="link-reporte" href="http://localhost:8000/reporte" download>
          <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
          </svg>
          Descargar Excel acumulativo
        </a>
      </div>

      <!-- Guía -->
      <div class="card">
        <div class="card-header">
          <div class="card-header-icon" style="background:var(--orange-light);">
            <svg viewBox="0 0 24 24" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"
              style="stroke:var(--orange);">
              <circle cx="12" cy="12" r="10" />
              <line x1="12" y1="8" x2="12" y2="12" />
              <line x1="12" y1="16" x2="12.01" y2="16" />
            </svg>
          </div>
          <div class="card-title">Guía Rápida</div>
        </div>
        <div style="font-size:.78rem; color:var(--text-muted); line-height:1.7;">
          <p style="margin-bottom:.6rem;">Complete los campos marcados con <strong
              style="color:var(--orange);">*</strong> y presione <strong>Derivar Ticket</strong>.</p>
          <p style="margin-bottom:.6rem;">El sistema consultará el histórico, estimará la complejidad y asignará la mesa
            de soporte automáticamente.</p>
          <p style="color:var(--text-light); font-size:.72rem;">Orquestado por n8n · Agentes: Histórico · Estimador ·
            Complejidad · Decisor</p>
        </div>
      </div>
    </div>

    <!-- ── Resultado ── -->
    <div class="card" id="resultado">
      <div class="card-header">
        <div class="card-header-icon" style="background:#dcfce7;">
          <svg viewBox="0 0 24 24" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"
            style="stroke:#15803d;">
            <polyline points="20 6 9 17 4 12" />
          </svg>
        </div>
        <div class="card-title">Resultado de Derivación</div>
      </div>
      <div id="resultado-content"></div>
    </div>

  </main>

  <!-- ── Dashboard ── -->
  <section id="dashboard-section" style="max-width:1200px; margin:2rem auto; padding:0 1.5rem;">

    <!-- Encabezado dashboard -->
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; flex-wrap:wrap; gap:.5rem;">
      <div style="display:flex; align-items:center; gap:.75rem;">
        <div style="background:var(--blue-light,#dbeafe); border-radius:8px; padding:.5rem; display:flex;">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="var(--blue,#1a6bbf)" stroke-width="1.75">
            <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
          </svg>
        </div>
        <div>
          <h2 style="font-size:1rem; font-weight:600; color:var(--text,#1e2a38); margin:0;">Dashboard de Métricas</h2>
          <p style="font-size:.75rem; color:var(--text-muted,#64748b); margin:0;">Histórico · Excel acumulativo · MLflow inferencias</p>
        </div>
      </div>
      <div style="display:flex; gap:.5rem; align-items:center;">
        <button id="btn-reload-dashboard" onclick="cargarDashboard()"
          style="background:var(--blue,#1a6bbf); color:#fff; border:none; padding:.35rem .9rem;
                 border-radius:6px; font-size:.78rem; cursor:pointer;">
          Actualizar
        </button>
        <a href="http://localhost:5001" target="_blank" rel="noopener"
          style="background:#f1f5f9; color:var(--blue,#1a6bbf); border:1px solid #cbd5e1; padding:.35rem .9rem;
                 border-radius:6px; font-size:.78rem; text-decoration:none; display:inline-flex; align-items:center; gap:.3rem;">
          <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
          Abrir MLflow UI
        </a>
      </div>
    </div>

    <!-- Cards de resumen -->
    <div id="dashboard-resumen" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:1rem; margin-bottom:1.5rem;">
      <div class="card" style="padding:1rem; text-align:center;">
        <div style="font-size:1.8rem; font-weight:700; color:var(--blue,#1a6bbf);" id="kpi-total">—</div>
        <div style="font-size:.75rem; color:var(--text-muted,#64748b);">Tickets procesados</div>
      </div>
      <div class="card" style="padding:1rem; text-align:center;">
        <div style="font-size:1.8rem; font-weight:700; color:#15803d;" id="kpi-pct">—</div>
        <div style="font-size:.75rem; color:var(--text-muted,#64748b);">% automatizado</div>
      </div>
      <div class="card" style="padding:1rem; text-align:center;">
        <div style="font-size:1.8rem; font-weight:700; color:#b45309;" id="kpi-historico">—</div>
        <div style="font-size:.75rem; color:var(--text-muted,#64748b);">Vía histórico</div>
      </div>
      <div class="card" style="padding:1rem; text-align:center;">
        <div style="font-size:1.8rem; font-weight:700; color:#dc2626;" id="kpi-cola">—</div>
        <div style="font-size:.75rem; color:var(--text-muted,#64748b);">En cola</div>
      </div>
    </div>

    <!-- Gráficos 2x2 -->
    <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:1rem;">

      <div class="card" style="padding:1rem;">
        <div style="font-size:.82rem; font-weight:600; color:var(--text,#1e2a38); margin-bottom:.75rem;">
          Distribución por Mesa
        </div>
        <canvas id="chart-mesas" height="200"></canvas>
      </div>

      <div class="card" style="padding:1rem;">
        <div style="font-size:.82rem; font-weight:600; color:var(--text,#1e2a38); margin-bottom:.75rem;">
          Distribución por Complejidad
        </div>
        <canvas id="chart-complejidad" height="200"></canvas>
      </div>

      <div class="card" style="padding:1rem;">
        <div style="font-size:.82rem; font-weight:600; color:var(--text,#1e2a38); margin-bottom:.75rem;">
          Distribución por Nivel (N1/N2/N3)
        </div>
        <canvas id="chart-niveles" height="200"></canvas>
      </div>

      <div class="card" style="padding:1rem;">
        <div style="font-size:.82rem; font-weight:600; color:var(--text,#1e2a38); margin-bottom:.75rem;">
          Tiempo estimado (categorías)
          <span id="kpi-latencia" style="font-weight:400; color:var(--text-muted,#64748b); margin-left:.5rem; font-size:.75rem;"></span>
        </div>
        <canvas id="chart-tiempo" height="200"></canvas>
      </div>

    </div>

    <p id="dashboard-error" style="color:#dc2626; font-size:.78rem; margin-top:.75rem; display:none;"></p>

  </section>

  <script src="actions.js"></script>
  <script>
  // ── Dashboard ─────────────────────────────────────────────────────────────
  const API = '';  // mismo origen (vacío = relativo)
  const CHART_COLORS = ['#1a6bbf','#e87722','#15803d','#dc2626','#7c3aed','#0891b2','#b45309','#475569'];
  let _charts = {};

  function _destroyChart(id) {
    if (_charts[id]) { _charts[id].destroy(); delete _charts[id]; }
  }

  function _makeBarChart(canvasId, labels, data, color) {
    _destroyChart(canvasId);
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    _charts[canvasId] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{ data, backgroundColor: color || CHART_COLORS, borderRadius: 4 }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
        responsive: true,
        maintainAspectRatio: true,
      }
    });
  }

  function _makeDoughnutChart(canvasId, labels, data) {
    _destroyChart(canvasId);
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    _charts[canvasId] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{ data, backgroundColor: CHART_COLORS, borderWidth: 1 }]
      },
      options: {
        plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } },
        responsive: true,
        maintainAspectRatio: true,
      }
    });
  }

  async function _fetch(path) {
    const r = await fetch(API + path);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  async function cargarDashboard() {
    const errEl = document.getElementById('dashboard-error');
    errEl.style.display = 'none';
    try {
      const [resumen, mesas, complejidad, niveles, tiempo] = await Promise.all([
        _fetch('/dashboard/datos/resumen'),
        _fetch('/dashboard/datos/mesas'),
        _fetch('/dashboard/datos/complejidad'),
        _fetch('/dashboard/datos/niveles'),
        _fetch('/dashboard/datos/tiempo'),
      ]);

      // KPIs
      document.getElementById('kpi-total').textContent     = resumen.total ?? '—';
      document.getElementById('kpi-pct').textContent       = resumen.pct_automatizado != null ? resumen.pct_automatizado + '%' : '—';
      document.getElementById('kpi-historico').textContent = resumen.via_historico ?? '—';
      document.getElementById('kpi-cola').textContent      = resumen.en_cola ?? '—';

      // Latencia MLflow
      if (tiempo.promedio_latencia_ms != null) {
        document.getElementById('kpi-latencia').textContent =
          `· latencia prom: ${tiempo.promedio_latencia_ms}ms (${tiempo.mlflow_runs_analizados} runs)`;
      }

      // Gráficos
      _makeDoughnutChart('chart-mesas', mesas.labels, mesas.data);
      _makeBarChart('chart-complejidad', complejidad.labels, complejidad.data);
      _makeDoughnutChart('chart-niveles', niveles.labels, niveles.data);
      _makeBarChart('chart-tiempo', tiempo.labels, tiempo.data, '#1a6bbf');

    } catch (e) {
      errEl.textContent = 'Dashboard no disponible: ' + e.message + '. ¿Está levantado agente-dashboard?';
      errEl.style.display = 'block';
    }
  }

  // Carga automática al abrir la página
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(cargarDashboard, 800);
  });
  </script>
</body>

</html>