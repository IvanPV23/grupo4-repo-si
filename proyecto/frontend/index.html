<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Derivaci√≥n de Tickets ‚Äî Protecta Seguros</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:         #0f1117;
      --surface:    #1a1d2e;
      --surface2:   #242840;
      --border:     #2e3250;
      --accent:     #4f8ef7;
      --accent2:    #6c63ff;
      --success:    #22c55e;
      --warning:    #f59e0b;
      --danger:     #ef4444;
      --text:       #e2e8f0;
      --text-muted: #8892b0;
      --radius:     12px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      background: linear-gradient(135deg, #1a1d2e 0%, #242840 100%);
      border-bottom: 1px solid var(--border);
      padding: 1.2rem 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .logo { font-size: 1.5rem; }
    header h1 { font-size: 1.1rem; font-weight: 600; }
    header p { font-size: 0.75rem; color: var(--text-muted); }
    .badge {
      margin-left: auto;
      background: rgba(79,142,247,0.15);
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 0.25rem 0.75rem;
      border-radius: 99px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    main {
      flex: 1;
      max-width: 1100px;
      width: 100%;
      margin: 2rem auto;
      padding: 0 1.5rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    @media (max-width: 768px) { main { grid-template-columns: 1fr; } }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
    }
    .card-title {
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* ‚îÄ‚îÄ Form ‚îÄ‚îÄ */
    .form-group { margin-bottom: 1rem; }
    label { display: block; font-size: 0.8rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.4rem; }
    input, select, textarea {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.65rem 0.9rem;
      color: var(--text);
      font-size: 0.875rem;
      font-family: inherit;
      transition: border-color .2s;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(79,142,247,0.15);
    }
    textarea { resize: vertical; min-height: 90px; }
    select option { background: var(--surface2); }

    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

    .checkbox-row {
      display: flex; align-items: center; gap: 0.6rem;
      margin-top: 0.3rem;
    }
    .checkbox-row input[type="checkbox"] {
      width: 1rem; height: 1rem; cursor: pointer;
      accent-color: var(--accent);
    }
    .checkbox-row label { margin: 0; cursor: pointer; font-size: 0.85rem; color: var(--text); }

    /* ‚îÄ‚îÄ Button ‚îÄ‚îÄ */
    .btn {
      width: 100%;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      border: none;
      border-radius: 10px;
      padding: 0.85rem;
      color: #fff;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .2s, transform .15s;
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* ‚îÄ‚îÄ Resultado ‚îÄ‚îÄ */
    #resultado { grid-column: 1 / -1; display: none; }

    .resultado-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.2rem;
    }

    .metric {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem;
      text-align: center;
    }
    .metric-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.4rem; }
    .metric-value { font-size: 1.2rem; font-weight: 700; }
    .metric-value.nivel-n1 { color: var(--success); }
    .metric-value.nivel-n2 { color: var(--warning); }
    .metric-value.nivel-n3 { color: var(--danger); }
    .metric-value.cola     { color: var(--warning); }

    .badge-comp {
      display: inline-block;
      padding: 0.2rem 0.7rem;
      border-radius: 99px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .comp-baja     { background: rgba(34,197,94,.15);  color: var(--success); }
    .comp-media    { background: rgba(245,158,11,.15); color: var(--warning); }
    .comp-alta     { background: rgba(239,68,68,.15);  color: var(--danger); }
    .comp-muy_alta { background: rgba(239,68,68,.25);  color: #ff6b6b; }

    .razonamiento {
      background: var(--surface2);
      border-left: 3px solid var(--accent);
      padding: 0.8rem 1rem;
      font-size: 0.78rem;
      color: var(--text-muted);
      border-radius: 0 8px 8px 0;
      line-height: 1.6;
    }

    .link-reporte {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      margin-top: 1rem;
      color: var(--accent);
      font-size: 0.8rem;
      text-decoration: none;
      border: 1px solid var(--accent);
      padding: 0.4rem 0.9rem;
      border-radius: 6px;
      transition: background .2s;
    }
    .link-reporte:hover { background: rgba(79,142,247,.1); }

    /* ‚îÄ‚îÄ Loading spinner ‚îÄ‚îÄ */
    .spinner {
      width: 18px; height: 18px;
      border: 2px solid rgba(255,255,255,.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
    .error-box {
      background: rgba(239,68,68,.1);
      border: 1px solid var(--danger);
      border-radius: 8px;
      padding: 1rem;
      color: #fca5a5;
      font-size: 0.85rem;
    }

    /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 1.2rem;
      border-bottom: 1px solid var(--border);
    }
    .tab {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-muted);
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: color .2s, border-color .2s;
    }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* ‚îÄ‚îÄ JSON editor ‚îÄ‚îÄ */
    #json-input {
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      min-height: 280px;
      line-height: 1.6;
      color: #a8d8a8;
      background: #0d1117;
      border: 1px solid var(--border);
    }
    .json-error { color: var(--danger); font-size: 0.75rem; margin-top: 0.4rem; min-height: 1rem; }

    /* ‚îÄ‚îÄ Historial lateral ‚îÄ‚îÄ */
    #historial-list { list-style: none; }
    #historial-list li {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.55rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.8rem;
    }
    #historial-list li:last-child { border-bottom: none; }
    .hist-id { font-family: monospace; color: var(--accent); }
    .hist-mesa { flex: 1; color: var(--text-muted); }
    .hist-nivel {
      font-size: 0.7rem;
      font-weight: 700;
      padding: 0.15rem 0.5rem;
      border-radius: 99px;
    }
    .n1 { background: rgba(34,197,94,.15);  color: var(--success); }
    .n2 { background: rgba(245,158,11,.15); color: var(--warning); }
    .n3 { background: rgba(239,68,68,.15);  color: var(--danger);  }
  </style>
</head>
<body>

<header>
  <div class="logo">üé´</div>
  <div>
    <h1>Sistema de Derivaci√≥n Inteligente</h1>
    <p>Pipeline multiagente ‚Äî Hist√≥rico ¬∑ Estimador ¬∑ Complejidad ¬∑ Orquestador</p>
  </div>
  <span class="badge">v3.0</span>
</header>

<main>

  <!-- ‚îÄ‚îÄ Formulario ‚îÄ‚îÄ -->
  <div class="card" style="grid-row: span 2;">
    <div class="card-title">üìã Nuevo Ticket</div>

    <!-- Pesta√±as -->
    <div class="tabs">
      <span class="tab active" onclick="switchTab('form')">üìù Formulario</span>
      <span class="tab" onclick="switchTab('json')">‚ö° JSON R√°pido</span>
    </div>

    <!-- Panel Formulario -->
    <div id="panel-form" class="tab-panel active">
    <form id="formTicket">
      <div class="form-group">
        <label>Tipo de Incidencia *</label>
        <select id="tipo_incidencia" required>
          <option value="">Selecciona...</option>
          <option value="Incidente">Incidente</option>
          <option value="Solicitud">Solicitud</option>
        </select>
      </div>

      <div class="form-group">
        <label>Resumen (t√≠tulo corto) *</label>
        <input id="resumen" type="text" placeholder="Ej: Error al emitir p√≥liza SOAT en ecommerce" required />
      </div>

      <div class="form-group">
        <label>Descripci√≥n detallada</label>
        <textarea id="descripcion_detallada" placeholder="Describe el problema con m√°s detalle, pasos para reproducir, etc."></textarea>
      </div>

      <div class="form-group">
        <label>Tipo de Atenci√≥n SD *</label>
        <select id="tipo_atencion_sd" required>
          <option value="">Selecciona...</option>
          <optgroup label="Simples (N1)">
            <option>Consulta</option>
            <option>Solicitud de informaci√≥n</option>
            <option>Actualizaci√≥n de datos</option>
            <option>Desafiliacion</option>
            <option>Alta de corredor</option>
            <option>Acceso</option>
          </optgroup>
          <optgroup label="Moderados (N1/N2)">
            <option>Emision</option>
            <option>Endoso</option>
            <option>Anulacion</option>
            <option>Reembolso</option>
            <option>Reporte</option>
            <option>Configuracion</option>
          </optgroup>
          <optgroup label="Complejos (N2/N3)">
            <option>Siniestro</option>
            <option>Error de aplicacion</option>
            <option>Error de sistema</option>
            <option>Error de servidor</option>
            <option>Integracion</option>
            <option>Factura</option>
            <option>Planilla</option>
            <option>Conciliacion</option>
          </optgroup>
        </select>
      </div>

      <div class="row2">
        <div class="form-group">
          <label>√Årea *</label>
          <select id="area" required>
            <option value="">Selecciona...</option>
            <option>Siniestros</option>
            <option>Comercial</option>
            <option>Operaciones</option>
            <option>Tecnolog√≠a</option>
            <option>Finanzas</option>
            <option>Recursos Humanos</option>
          </select>
        </div>
        <div class="form-group">
          <label>Producto</label>
          <select id="producto">
            <option value="">Selecciona...</option>
            <option>SOAT</option>
            <option>Vida Ley</option>
            <option>SCTR</option>
            <option>Vida Individual</option>
            <option>EPS</option>
            <option>Otro</option>
          </select>
        </div>
      </div>

      <div class="row2">
        <div class="form-group">
          <label>Aplicativo</label>
          <input id="aplicativo" type="text" placeholder="Ej: Ecommerce SOAT, PAS..." />
        </div>
        <div class="form-group">
          <label>Informador (qui√©n reporta)</label>
          <input id="informador" type="text" placeholder="nombre@empresa.com" />
        </div>
      </div>

      <div class="row2">
        <div class="form-group">
          <label>Cantidad de afectados</label>
          <input id="cantidad_afectados" type="number" min="1" value="1" />
        </div>
        <div class="form-group" style="display:flex; align-items:flex-end;">
          <div class="checkbox-row">
            <input type="checkbox" id="impacta_al_cierre" />
            <label for="impacta_al_cierre">¬øImpacta al cierre contable?</label>
          </div>
        </div>
      </div>

      <button class="btn" type="submit" id="btnEnviar">
        <span>üöÄ Derivar Ticket</span>
      </button>
    </form>
    </div><!-- /panel-form -->

    <!-- Panel JSON R√°pido -->
    <div id="panel-json" class="tab-panel">
      <label style="font-size:.75rem;color:var(--text-muted);display:block;margin-bottom:.5rem">
        Pega o edita el JSON del ticket y presiona Enviar:
      </label>
      <textarea id="json-input" spellcheck="false"></textarea>
      <div class="json-error" id="json-error"></div>
      <button class="btn" id="btnJsonEnviar" onclick="enviarJSON()" style="margin-top:.7rem">
        <span>‚ö° Enviar JSON</span>
      </button>
    </div><!-- /panel-json -->

  </div>

  <!-- ‚îÄ‚îÄ Historial reciente ‚îÄ‚îÄ -->
  <div class="card">
    <div class="card-title">üïê √öltimas derivaciones</div>
    <ul id="historial-list">
      <li style="color:var(--text-muted);font-size:.8rem">A√∫n no hay tickets procesados.</li>
    </ul>
    <a class="link-reporte" href="http://localhost:8000/reporte" download>
      üì• Descargar Excel acumulativo
    </a>
  </div>

  <!-- ‚îÄ‚îÄ Resultado ‚îÄ‚îÄ -->
  <div class="card" id="resultado">
    <div class="card-title">‚úÖ Resultado de Derivaci√≥n</div>
    <div id="resultado-content"></div>
  </div>

</main>

<script>
  const API = 'http://localhost:8000';
  const historial = [];

  // ‚îÄ‚îÄ Ejemplo pre-cargado en el textarea JSON ‚îÄ‚îÄ
  const EJEMPLO_JSON = {
    tipo_incidencia: "Incidente",
    resumen: "Error al emitir p√≥liza SOAT en ecommerce",
    descripcion_detallada: "El portal no permite completar la transacci√≥n de compra. Afecta a m√∫ltiples usuarios.",
    tipo_atencion_sd: "Error de sistema",
    area: "Siniestros",
    producto: "SOAT",
    aplicativo: "Ecommerce SOAT",
    informador: "analista@protecta.pe",
    cantidad_afectados: 5,
    impacta_al_cierre: false
  };
  document.getElementById('json-input').value = JSON.stringify(EJEMPLO_JSON, null, 2);

  // ‚îÄ‚îÄ Cambio de pesta√±as ‚îÄ‚îÄ
  function switchTab(tab) {
    document.querySelectorAll('.tab').forEach((t, i) => {
      t.classList.toggle('active', (i === 0 && tab === 'form') || (i === 1 && tab === 'json'));
    });
    document.getElementById('panel-form').classList.toggle('active', tab === 'form');
    document.getElementById('panel-json').classList.toggle('active', tab === 'json');
  }

  // ‚îÄ‚îÄ Enviar JSON crudo ‚îÄ‚îÄ
  async function enviarJSON() {
    const btn = document.getElementById('btnJsonEnviar');
    const errDiv = document.getElementById('json-error');
    errDiv.textContent = '';
    let payload;
    try {
      payload = JSON.parse(document.getElementById('json-input').value);
    } catch (e) {
      errDiv.textContent = '‚ö†Ô∏è JSON inv√°lido: ' + e.message;
      return;
    }
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div><span>Procesando...</span>';
    try {
      const res = await fetch(`${API}/tickets/nuevo`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || 'Error del servidor');
      mostrarResultado(data);
    } catch (err) {
      mostrarError(err.message);
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<span>‚ö° Enviar JSON</span>';
    }
  }

  document.getElementById('formTicket').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btnEnviar');
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div><span>Procesando...</span>';

    const payload = {
      tipo_incidencia:       document.getElementById('tipo_incidencia').value,
      resumen:               document.getElementById('resumen').value,
      descripcion_detallada: document.getElementById('descripcion_detallada').value,
      tipo_atencion_sd:      document.getElementById('tipo_atencion_sd').value,
      area:                  document.getElementById('area').value,
      producto:              document.getElementById('producto').value,
      aplicativo:            document.getElementById('aplicativo').value,
      informador:            document.getElementById('informador').value,
      cantidad_afectados:    parseInt(document.getElementById('cantidad_afectados').value) || 1,
      impacta_al_cierre:     document.getElementById('impacta_al_cierre').checked,
    };

    try {
      const res = await fetch(`${API}/tickets/nuevo`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || 'Error del servidor');
      mostrarResultado(data);
    } catch (err) {
      mostrarError(err.message);
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<span>üöÄ Derivar Ticket</span>';
    }
  });

  function nivelClass(nivel) {
    return nivel === 'N1' ? 'nivel-n1' : nivel === 'N2' ? 'nivel-n2' : 'nivel-n3';
  }

  function compClass(comp) {
    return `badge-comp comp-${comp}`;
  }

  function mostrarResultado(d) {
    const box = document.getElementById('resultado');
    const content = document.getElementById('resultado-content');
    box.style.display = 'block';

    const tiempoStr = d.tiempo_estimado_horas != null
      ? `${d.tiempo_estimado_horas}h (${d.categoria_tiempo || ''})`
      : '‚Äî';

    content.innerHTML = `
      <div class="resultado-grid">
        <div class="metric">
          <div class="metric-label">Mesa Asignada</div>
          <div class="metric-value" style="font-size:.95rem;color:var(--text)">${d.mesa_asignada}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Nivel</div>
          <div class="metric-value ${nivelClass(d.nivel_asignado)}">${d.nivel_asignado}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Complejidad</div>
          <div class="metric-value" style="font-size:1rem">
            <span class="${compClass(d.complejidad)}">${d.complejidad.toUpperCase()}</span>
            <div style="font-size:.7rem;color:var(--text-muted);margin-top:.2rem">score ${d.score_complejidad}</div>
          </div>
        </div>
        <div class="metric">
          <div class="metric-label">Tiempo Estimado</div>
          <div class="metric-value" style="font-size:.95rem;color:var(--accent)">${tiempoStr}</div>
        </div>
        <div class="metric">
          <div class="metric-label">V√≠a Hist√≥rico</div>
          <div class="metric-value" style="font-size:.95rem">${d.via_historico ? '‚úÖ S√≠' : '‚ùå No'}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Estado</div>
          <div class="metric-value ${d.en_cola ? 'cola' : 'nivel-n1'}" style="font-size:.85rem">
            ${d.en_cola ? '‚è≥ En cola' : '‚úÖ Asignado'}
          </div>
        </div>
      </div>
      <div style="font-size:.7rem;color:var(--text-muted);margin-bottom:.5rem">
        Ticket ID: <code style="color:var(--accent)">${d.ticket_id}</code>
      </div>
      <div class="razonamiento">${d.razonamiento}</div>
    `;

    // Agregar al historial lateral
    historial.unshift({ id: d.ticket_id, mesa: d.mesa_asignada, nivel: d.nivel_asignado });
    actualizarHistorial();

    box.scrollIntoView({ behavior: 'smooth' });
  }

  function mostrarError(msg) {
    const box = document.getElementById('resultado');
    const content = document.getElementById('resultado-content');
    box.style.display = 'block';
    content.innerHTML = `<div class="error-box">‚ö†Ô∏è ${msg}</div>`;
    box.scrollIntoView({ behavior: 'smooth' });
  }

  function actualizarHistorial() {
    const ul = document.getElementById('historial-list');
    if (historial.length === 0) {
      ul.innerHTML = '<li style="color:var(--text-muted);font-size:.8rem">A√∫n no hay tickets procesados.</li>';
      return;
    }
    ul.innerHTML = historial.slice(0, 8).map(h => `
      <li>
        <span class="hist-id">${h.id}</span>
        <span class="hist-mesa">${h.mesa}</span>
        <span class="hist-nivel ${h.nivel.toLowerCase()}">${h.nivel}</span>
      </li>
    `).join('');
  }
</script>
</body>
</html>
