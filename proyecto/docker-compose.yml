version: '3.8'

services:

  # =====================================================
  # n8n - Orquestador de Workflows
  # =====================================================
  n8n:
    image: n8nio/n8n:latest
    container_name: sistema-tickets-n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=admin123
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=America/Lima
      - DB_SQLITE_PATH=/home/node/.n8n/database.sqlite
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - tickets-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =====================================================
  # API Principal — FastAPI v3.0
  # =====================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sistema-tickets-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - AGENTE_HISTORICO_URL=http://agente-historico:8004
      - AGENTE_ESTIMADOR_URL=http://agente-estimador:8005
      - AGENTE_COMPLEJIDAD_URL=http://agente-complejidad:8001
      - AGENTE_ORQUESTADOR_URL=http://agente-orquestador:8003
      - JIRA_API_TOKEN=ATATT3xFfGF094mZSiL3wsQDIAecBwoVhIceEYrv7D4lnqcXWGpeFEqfvOyiOwU9m9JiPzWhgalbeeHxmVZQGHhFqOHG_7tl9sJtDE53tKRZTweBqubABsjNv_QkEfiKfINHKdnw5-hZFFNSziUEKBWeIPp0OISugzEUxdmEAlcT1wryn3ahTFw=848CEDB4
      - JIRA_DOMAIN=jhairrmb3.atlassian.net
      - JIRA_EMAIL=jhairrmb3@gmail.com
      - JIRA_PROJECT_KEY=SOP
      - JIRA_ACCOUNT_ID=712020:4891c296-4785-48fc-8dfe-84c7205f6679
    volumes:
      - ./api:/app/api
      - ./models:/app/models
      - ./utils:/app/utils
      - ./data:/app/data
      - ./frontend:/app/frontend
    depends_on:
      - n8n
      - agente-historico
      - agente-estimador
      - agente-complejidad
      - agente-orquestador
    networks:
      - tickets-network
    command: uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload

  # =====================================================
  # Agente HISTÓRICO — Puerto 8004
  # Busca tickets similares ya resueltos en el historial
  # =====================================================
  agente-historico:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: agente-historico
    restart: unless-stopped
    ports:
      - "8004:8004"
    environment:
      - AGENT_NAME=historico
      - AGENT_PORT=8004
    volumes:
      - ./agents/historico:/app/agents/historico
      - ./data:/app/data
    networks:
      - tickets-network
    command: uvicorn agents.historico.main:app --host 0.0.0.0 --port 8004 --reload

  # =====================================================
  # Agente ESTIMADOR — Puerto 8005
  # Estima tiempo de resolución (rule-based, ML después)
  # =====================================================
  agente-estimador:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: agente-estimador
    restart: unless-stopped
    ports:
      - "8005:8005"
    environment:
      - AGENT_NAME=estimador
      - AGENT_PORT=8005
    volumes:
      - ./agents/estimador:/app/agents/estimador
      - ./models:/app/models
      - ./data:/app/data
    networks:
      - tickets-network
    command: uvicorn agents.estimador.main:app --host 0.0.0.0 --port 8005 --reload

  # =====================================================
  # Agente COMPLEJIDAD v2 — Puerto 8001
  # Determina complejidad con keywords + tiempo estimado
  # =====================================================
  agente-complejidad:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: agente-complejidad
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - AGENT_NAME=complejidad
      - AGENT_PORT=8001
    volumes:
      - ./agents/complejidad:/app/agents/complejidad
      - ./data:/app/data
    networks:
      - tickets-network
    command: uvicorn agents.complejidad.main:app --host 0.0.0.0 --port 8001 --reload

  # =====================================================
  # Agente ORQUESTADOR — Puerto 8003
  # Asigna mesa final, verica carga, gestiona cola
  # (reemplaza a Decisor + Capacidad)
  # =====================================================
  agente-orquestador:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: agente-orquestador
    restart: unless-stopped
    ports:
      - "8003:8003"
    environment:
      - AGENT_NAME=orquestador
      - AGENT_PORT=8003
    volumes:
      - ./agents/decisor:/app/agents/decisor
      - ./data:/app/data
    networks:
      - tickets-network
    command: uvicorn agents.decisor.main:app --host 0.0.0.0 --port 8003 --reload

networks:
  tickets-network:
    driver: bridge

volumes:
  n8n_data: